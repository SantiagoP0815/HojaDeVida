<div class="edit-layout-container">
    
    <div class="sidebar-menu">
        <h5 class="text-muted mb-4 ps-2">Menú de Edición</h5>
        
        <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
            <button class="nav-link active" id="v-pills-datos-tab" data-bs-toggle="pill" data-bs-target="#v-pills-datos" type="button" role="tab">
                <i class="fas fa-user-circle"></i> Datos Personales
            </button>
            <button class="nav-link" id="v-pills-formacion-tab" data-bs-toggle="pill" data-bs-target="#v-pills-formacion" type="button" role="tab">
                <i class="fas fa-graduation-cap"></i> Formación Académica
            </button>
            <button class="nav-link" id="v-pills-idiomas-tab" data-bs-toggle="pill" data-bs-target="#v-pills-idiomas" type="button" role="tab">
                <i class="fas fa-language"></i> Idiomas
            </button>
            <button class="nav-link" id="v-pills-experiencia-tab" data-bs-toggle="pill" data-bs-target="#v-pills-experiencia" type="button" role="tab">
                <i class="fas fa-briefcase"></i> Experiencia Laboral
            </button>
            <button class="nav-link" id="v-pills-tiempo-tab" data-bs-toggle="pill" data-bs-target="#v-pills-tiempo" type="button" role="tab">
                <i class="fas fa-clock"></i> Tiempo Total
            </button>
        </div>

        <div class="mt-auto pt-4 border-top">
            <button type="button" class="btn btn-success w-100 mb-2 shadow-sm" onclick="enviarFormulario()">
                <i class="fas fa-save me-2"></i> Guardar Todo
            </button>
            <button type="button" class="btn btn-primary w-100 mb-2 shadow-sm" onclick="descargarPDF()">
                <i class="fas fa-file-pdf me-2"></i> Descargar PDF
            </button>
            <button type="button" class="btn btn-outline-secondary w-100 btn-sm" onclick="window.open('/hoja/view/{{user.unique_identifier}}', '_blank')">
                <i class="fas fa-share-alt me-2"></i> Compartir Enlace
            </button>
        </div>
    </div>

    <div class="content-area">
        <form id="datos-form" action="/hoja/insertar-datos" method="POST" enctype="multipart/form-data">
            
            <div class="tab-content" id="v-pills-tabContent">
                
                <div class="tab-pane fade show active" id="v-pills-datos" role="tabpanel">
                    <div class="form-card">
                        <h2 class="section-title"><i class="fas fa-user-edit"></i> Datos Personales</h2>
                        
                        <div class="row">
                            <div class="col-md-6 nice-form-group">
                                <label>Nombres</label>
                                <input type="text" name="nombres" value="{{user.nombres}}" required />
                            </div>
                            <div class="col-md-6 nice-form-group">
                                <label>Primer Apellido</label>
                                <input type="text" name="primer_apellido" value="{{user.primer_apellido}}" required />
                            </div>
                            <div class="col-md-6 nice-form-group">
                                <label>Segundo Apellido</label>
                                <input type="text" name="segundo_apellido" value="{{user.segundo_apellido}}" />
                            </div>
                            <div class="col-md-6 nice-form-group">
                                <label>Teléfono</label>
                                <input type="tel" name="telefono" value="{{user.telefono}}" />
                            </div>
                            <div class="col-md-12 nice-form-group">
                                <label>Email</label>
                                <input type="email" name="email" value="{{user.email}}" />
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row">
                            <div class="col-md-4 nice-form-group">
                                <label>Tipo Documento</label>
                                <select name="tipo_documento" class="form-control">
                                    <option value="C.C" {{#if (eq user.tipo_documento "C.C")}}selected{{/if}}>Cédula de Ciudadanía</option>
                                    <option value="C.E" {{#if (eq user.tipo_documento "C.E")}}selected{{/if}}>Cédula de Extranjería</option>
                                    <option value="PAS" {{#if (eq user.tipo_documento "PAS")}}selected{{/if}}>Pasaporte</option>
                                </select>
                            </div>
                            <div class="col-md-8 nice-form-group">
                                <label>Número Documento</label>
                                <input type="text" name="numero_documento" value="{{user.numero_documento}}" required />
                            </div>
                            <div class="col-md-12 nice-form-group">
                                <label>Documento Escaneado</label>
                                <input type="file" name="documento_id" />
                                {{#if user.nombre_original_archivo}}
                                    <small class="text-success d-block mt-1"><i class="fas fa-check-circle"></i> Archivo actual: {{user.nombre_original_archivo}}</small>
                                {{/if}}
                            </div>
                        </div>

                        <hr class="my-4">
                        
                        <h5 class="mb-3">Lugar de Nacimiento</h5>
                        <div class="row">
                            <div class="col-md-4 nice-form-group"><label>País</label><input type="text" name="pais_nacimiento" value="{{user.pais_nacimiento}}" /></div>
                            <div class="col-md-4 nice-form-group"><label>Departamento</label><input type="text" name="departamento_nacimiento" value="{{user.departamento_nacimiento}}" /></div>
                            <div class="col-md-4 nice-form-group"><label>Municipio</label><input type="text" name="municipio_nacimiento" value="{{user.municipio_nacimiento}}" /></div>
                            <div class="col-md-6 nice-form-group"><label>Fecha Nacimiento</label><input type="date" name="fecha_nacimiento" value="{{user.fecha_nacimiento}}" /></div>
                        </div>
                        
                        <div class="nice-form-group mt-3">
                            <label>Dirección Correspondencia</label>
                            <input type="text" name="direccion_correspondencia" value="{{user.direccion_correspondencia}}" />
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="v-pills-formacion" role="tabpanel">
                    <div class="form-card">
                        <h2 class="section-title"><i class="fas fa-graduation-cap"></i> Educación Básica y Media</h2>
                        <div class="nice-form-group">
                            <label>Último grado aprobado (1-11)</label>
                            <div class="d-flex flex-wrap gap-2 mt-2">
                                {{#each (range 1 12)}}
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="educacion_basica" id="grado_{{this}}" value="{{this}}" {{#if (eq ../educacion_basica_media.educacion_basica (add "" this))}}checked{{/if}}>
                                    <label class="form-check-label" for="grado_{{this}}">{{this}}°</label>
                                </div>
                                {{/each}}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8 nice-form-group">
                                <label>Título Obtenido (Bachiller)</label>
                                <input type="text" name="titulo_obtenido" value="{{educacion_basica_media.titulo_obtenido}}" />
                            </div>
                            <div class="col-md-4 nice-form-group">
                                <label>Fecha Grado</label>
                                <input type="month" name="fecha_grado" value="{{educacion_basica_media.fecha_grado}}" />
                            </div>
                        </div>
                    </div>

                    <div class="form-card">
                        <h2 class="section-title"><i class="fas fa-university"></i> Educación Superior</h2>
                        <div id="academic-container">
                            {{#if educacion_superior.length}}
                                {{#each educacion_superior}}
                                <div class="dynamic-block academic-block">
                                    <input type="hidden" name="id_educacion_superior_{{@index}}" value="{{this.id_educacion_superior}}" />
                                    <div class="row">
                                        <div class="col-md-6 nice-form-group">
                                            <label>Modalidad</label>
                                            <select name="modalidad_academica_{{@index}}">
                                                <option value="UNIVERSITARIA" {{#if (eq this.modalidad_academica "UNIVERSITARIA")}}selected{{/if}}>Universitaria</option>
                                                <option value="TECNICA" {{#if (eq this.modalidad_academica "TECNICA")}}selected{{/if}}>Técnica</option>
                                                <option value="TECNOLOGA" {{#if (eq this.modalidad_academica "TECNOLOGA")}}selected{{/if}}>Tecnológica</option>
                                                <option value="ESPECIALIZACION" {{#if (eq this.modalidad_academica "ESPECIALIZACION")}}selected{{/if}}>Especialización</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 nice-form-group">
                                            <label>Título Obtenido</label>
                                            <input type="text" name="nombre_titulo_{{@index}}" value="{{this.nombre_titulo}}" />
                                        </div>
                                    </div>
                                    <div class="nice-form-group">
                                        <label>Soporte (PDF/Imagen)</label>
                                        <input type="file" name="documento_educacion_superior_{{@index}}" />
                                    </div>
                                </div>
                                {{/each}}
                            {{else}}
                                <div class="dynamic-block academic-block">
                                    <input type="hidden" name="id_educacion_superior_0" value="" />
                                    <div class="row">
                                        <div class="col-md-6 nice-form-group">
                                            <label>Modalidad</label>
                                            <select name="modalidad_academica_0">
                                                <option value="UNIVERSITARIA">Universitaria</option>
                                                <option value="TECNICA">Técnica</option>
                                                <option value="TECNOLOGA">Tecnológica</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 nice-form-group">
                                            <label>Título Obtenido</label>
                                            <input type="text" name="nombre_titulo_0" />
                                        </div>
                                    </div>
                                    <div class="nice-form-group">
                                        <label>Soporte</label>
                                        <input type="file" name="documento_educacion_superior_0" />
                                    </div>
                                </div>
                            {{/if}}
                        </div>
                        <div class="text-end">
                            <button type="button" id="remove-academic" class="btn btn-outline-danger btn-sm me-2">Eliminar último</button>
                            <button type="button" id="add-academic" class="btn btn-outline-success btn-sm">Agregar otro estudio</button>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="v-pills-idiomas" role="tabpanel">
                    <div class="form-card">
                        <h2 class="section-title"><i class="fas fa-language"></i> Idiomas</h2>
                        <div id="languages-container">
                            {{#if idiomas.length}}
                                {{#each idiomas}}
                                <div class="dynamic-block language-block">
                                    <input type="hidden" name="id_idioma_{{@index}}" value="{{this.id_idioma}}" />
                                    <div class="nice-form-group">
                                        <label>Idioma</label>
                                        <input type="text" name="idioma_{{@index}}" value="{{this.idioma}}" />
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4"><label>Habla</label><select name="habla_{{@index}}" class="form-control"><option>Bien</option><option>Regular</option></select></div>
                                        <div class="col-md-4"><label>Lee</label><select name="lee_{{@index}}" class="form-control"><option>Bien</option><option>Regular</option></select></div>
                                        <div class="col-md-4"><label>Escribe</label><select name="escribe_{{@index}}" class="form-control"><option>Bien</option><option>Regular</option></select></div>
                                    </div>
                                </div>
                                {{/each}}
                            {{else}}
                                <div class="dynamic-block language-block">
                                    <input type="hidden" name="id_idioma_0" value="" />
                                    <div class="nice-form-group"><label>Idioma</label><input type="text" name="idioma_0" /></div>
                                    </div>
                            {{/if}}
                        </div>
                        <div class="text-end mt-3">
                            <button type="button" id="remove-language" class="btn btn-outline-danger btn-sm me-2">Eliminar</button>
                            <button type="button" id="add-language" class="btn btn-outline-success btn-sm">Agregar Idioma</button>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="v-pills-experiencia" role="tabpanel">
                    <div class="form-card">
                        <h2 class="section-title"><i class="fas fa-briefcase"></i> Experiencia Laboral</h2>
                        
                        <div class="dynamic-block border-primary">
                            <h5 class="text-primary mb-3">Empleo Actual</h5>
                            <input type="hidden" name="id_experiencia_0" value="{{empleoActual.id_experiencia}}" />
                            <input type="hidden" name="empleo_actual_0" value="SI" />
                            <div class="row">
                                <div class="col-md-6 nice-form-group">
                                    <label>Empresa</label>
                                    <input type="text" name="empresa_entidad_0" value="{{empleoActual.empresa_entidad}}" />
                                </div>
                                <div class="col-md-6 nice-form-group">
                                    <label>Cargo</label>
                                    <input type="text" name="cargo_actual_0" value="{{empleoActual.cargo_actual}}" />
                                </div>
                                <div class="col-md-6 nice-form-group">
                                    <label>Fecha Ingreso</label>
                                    <input type="date" name="fecha_ingreso_0" value="{{empleoActual.fecha_ingreso}}" />
                                </div>
                            </div>
                        </div>

                        <h5 class="mb-3 mt-4">Empleos Anteriores</h5>
                        <div id="empleos-container">
                            {{#if empleosAnteriores.length}}
                                {{#each empleosAnteriores}}
                                <div class="dynamic-block empleos-block">
                                    <input type="hidden" name="empleo_actual_{{add @index 1}}" value="NO" />
                                    <input type="hidden" name="id_experiencia_{{add @index 1}}" value="{{this.id_experiencia}}" />
                                    <div class="nice-form-group">
                                        <label>Empresa Anterior</label>
                                        <input type="text" name="empresa_entidad_{{add @index 1}}" value="{{this.empresa_entidad}}" />
                                    </div>
                                    </div>
                                {{/each}}
                            {{else}}
                                <div class="dynamic-block empleos-block">
                                    <input type="hidden" name="empleo_actual_1" value="NO" />
                                    <input type="hidden" name="id_experiencia_1" value="" />
                                    <div class="nice-form-group">
                                        <label>Empresa Anterior</label>
                                        <input type="text" name="empresa_entidad_1" />
                                    </div>
                                </div>
                            {{/if}}
                        </div>
                        <div class="text-end mt-3">
                            <button type="button" id="remove-empleos" class="btn btn-outline-danger btn-sm me-2">Eliminar</button>
                            <button type="button" id="add-empleos" class="btn btn-outline-success btn-sm">Agregar Empleo</button>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="v-pills-tiempo" role="tabpanel">
                    <div class="form-card">
                        <h2 class="section-title"><i class="fas fa-clock"></i> Tiempo Total Experiencia</h2>
                        <div class="row">
                            <div class="col-md-6 nice-form-group">
                                <label>Años en Sector Público</label>
                                <input type="number" name="anios_servidor_publico" value="{{tiempo_experiencia.anios_servidor_publico}}" />
                            </div>
                            <div class="col-md-6 nice-form-group">
                                <label>Años en Sector Privado</label>
                                <input type="number" name="anios_sector_privado" value="{{tiempo_experiencia.anios_sector_privado}}" />
                            </div>
                            <div class="col-md-12 nice-form-group">
                                <label>Total Años Experiencia</label>
                                <input type="number" name="anios_total_experiencia" value="{{tiempo_experiencia.anios_total_experiencia}}" class="fw-bold" />
                            </div>
                        </div>
                    </div>
                </div>

            </div> </form>
    </div>
</div>

<script>
    // Función simple para agregar bloques
    function setupDynamicBlocks(addBtnId, removeBtnId, containerId, blockClass) {
        const addBtn = document.getElementById(addBtnId);
        const removeBtn = document.getElementById(removeBtnId);
        const container = document.getElementById(containerId);

        if(addBtn && container) {
            addBtn.addEventListener('click', () => {
                const blocks = container.querySelectorAll('.' + blockClass);
                if(blocks.length >= 5) return alert('Máximo 5 registros permitidos.');
                
                const newBlock = blocks[0].cloneNode(true);
                const newIndex = blocks.length + (blockClass === 'empleos-block' ? 1 : 0); // Ajuste índice empleos empieza en 1
                
                // Limpiar valores y actualizar IDs/Names
                newBlock.querySelectorAll('input, select').forEach(input => {
                    if(input.name) input.name = input.name.replace(/_\d+$/, `_${newIndex}`);
                    if(input.id) input.id = input.id.replace(/_\d+$/, `_${newIndex}`);
                    input.value = ''; 
                    if(input.type === 'hidden' && input.name.includes('id_')) input.value = '';
                });

                container.appendChild(newBlock);
            });
        }

        if(removeBtn && container) {
            removeBtn.addEventListener('click', () => {
                const blocks = container.querySelectorAll('.' + blockClass);
                if(blocks.length > 1) {
                    container.removeChild(blocks[blocks.length - 1]);
                } else {
                    // Si es el último, solo limpiar inputs
                    blocks[0].querySelectorAll('input').forEach(i => i.value = '');
                }
            });
        }
    }

    // Inicializar lógica dinámica
    setupDynamicBlocks('add-academic', 'remove-academic', 'academic-container', 'academic-block');
    setupDynamicBlocks('add-language', 'remove-language', 'languages-container', 'language-block');
    setupDynamicBlocks('add-empleos', 'remove-empleos', 'empleos-container', 'empleos-block');

    function enviarFormulario() {
        document.getElementById('datos-form').submit();
    }

    function descargarPDF() {
        // Tu lógica original de fetch
        window.location.href = '/hoja/generar-pdf'; 
    }
</script>